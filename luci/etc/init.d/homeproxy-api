#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1

SERVICE_NAME='homeproxy-api'
SERVICE_CONF='homeproxy-api'
HOMEPROXY_CONF='homeproxy'
GEN_CLIENT='/etc/homeproxy/scripts/generate_client.uc'

sync_autostart() {
	config_load "$SERVICE_CONF"
	config_get autostart main autostart '1'

	if [ "$autostart" = '1' ]; then
		/etc/init.d/$SERVICE_NAME enable >/dev/null 2>&1
	else
		/etc/init.d/$SERVICE_NAME disable >/dev/null 2>&1
	fi
}

patch_generate_client_for_clash_api() {
	[ -s "$GEN_CLIENT" ] || return 1

	if ! grep -q "clash_api_enabled" "$GEN_CLIENT"; then
		sed -i "/const mixed_port/i\
const clash_api_enabled = uci.get(uciconfig, ucicontrol, 'clash_api_enabled') || '0',\
      clash_api_listen = uci.get(uciconfig, ucicontrol, 'clash_api_listen') || '0.0.0.0:9090',\
      clash_api_secret = uci.get(uciconfig, ucicontrol, 'clash_api_secret'),\
      clash_api_mode = uci.get(uciconfig, ucicontrol, 'clash_api_mode') || 'Rule';\
" "$GEN_CLIENT"
	fi

	if ! grep -q "config.experimental.clash_api" "$GEN_CLIENT"; then
		sed -i "/\/\* Experimental end \*\//i\
	if (strToBool(clash_api_enabled)) {\
		config.experimental.clash_api = {\
			external_controller: clash_api_listen,\
			secret: clash_api_secret,\
			default_mode: clash_api_mode,\
		};\
	}\
" "$GEN_CLIENT"
	fi
}

sync_clash_api() {
	config_load "$SERVICE_CONF"
	config_get clash_api_port main clash_api_port '9090'

	case "$clash_api_port" in
		''|*[!0-9]*) clash_api_port='9090' ;;
	esac

	[ -x /etc/init.d/homeproxy ] || return 0
	[ -x /usr/bin/sing-box ] || return 0
	uci -q get "$HOMEPROXY_CONF.control" >/dev/null 2>&1 || return 0

	patch_generate_client_for_clash_api >/dev/null 2>&1 || true

	local listen_addr changed cur
	listen_addr="0.0.0.0:$clash_api_port"
	changed='0'

	cur="$(uci -q get $HOMEPROXY_CONF.control.clash_api_enabled)"
	[ "$cur" = '1' ] || {
		uci -q set $HOMEPROXY_CONF.control.clash_api_enabled='1'
		changed='1'
	}

	cur="$(uci -q get $HOMEPROXY_CONF.control.clash_api_listen)"
	[ "$cur" = "$listen_addr" ] || {
		uci -q set $HOMEPROXY_CONF.control.clash_api_listen="$listen_addr"
		changed='1'
	}

	cur="$(uci -q get $HOMEPROXY_CONF.control.clash_api_secret)"
	[ -z "$cur" ] || {
		uci -q set $HOMEPROXY_CONF.control.clash_api_secret=''
		changed='1'
	}

	cur="$(uci -q get $HOMEPROXY_CONF.control.clash_api_mode)"
	[ "$cur" = 'Rule' ] || {
		uci -q set $HOMEPROXY_CONF.control.clash_api_mode='Rule'
		changed='1'
	}

	if [ "$changed" = '1' ]; then
		uci -q commit "$HOMEPROXY_CONF"
		/etc/init.d/homeproxy restart >/dev/null 2>&1 || true
	fi
}

start_service() {
	config_load "$SERVICE_CONF"
	config_get enabled main enabled '1'
	config_get bin main bin '/usr/bin/homeproxy-api'
	config_get listen main listen '0.0.0.0:7878'
	config_get port main port ''
	config_get mode main mode 'default'
	config_get db main db '/var/run/homeproxy/cache.db'
	config_get cfg main config '/var/run/homeproxy/sing-box-c.json'
	config_get origin main allow_origin '*'

	sync_autostart
	sync_clash_api

	[ "$enabled" = '1' ] || return 0
	[ -x "$bin" ] || return 0
	[ -s "$cfg" ] || return 0
	[ -e "$db" ] || return 0

	case "$mode" in
		eco|default) ;;
		*) mode='default' ;;
	esac

	procd_open_instance
	procd_set_param command "$bin"
	if [ -n "$port" ]; then
		procd_append_param command -port "$port"
	else
		procd_append_param command -listen "$listen"
	fi
	procd_append_param command -mode "$mode" -db "$db" -config "$cfg" -allow-origin "$origin"
	procd_set_param respawn 3600 5 5
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
}

reload_service() {
	sync_autostart
	sync_clash_api
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "$SERVICE_CONF"
}
