#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1

SERVICE_NAME='homeproxy-api'
SERVICE_CONF='homeproxy-api'

sync_autostart() {
	config_load "$SERVICE_CONF"
	config_get autostart main autostart '1'

	if [ "$autostart" = '1' ]; then
		/etc/init.d/$SERVICE_NAME enable >/dev/null 2>&1
	else
		/etc/init.d/$SERVICE_NAME disable >/dev/null 2>&1
	fi
}

start_service() {
	config_load "$SERVICE_CONF"
	config_get enabled main enabled '1'
	config_get bin main bin '/usr/bin/homeproxy-api'
	config_get listen main listen '0.0.0.0:7878'
	config_get port main port ''
	config_get mode main mode 'default'
	config_get db main db '/var/run/homeproxy/cache.db'
	config_get cfg main config '/var/run/homeproxy/sing-box-c.json'
	config_get origin main allow_origin '*'

	sync_autostart

	[ "$enabled" = '1' ] || return 0
	[ -x "$bin" ] || return 0
	[ -s "$cfg" ] || return 0
	[ -e "$db" ] || return 0

	case "$mode" in
		eco|default) ;;
		*) mode='default' ;;
	esac

	procd_open_instance
	procd_set_param command "$bin"
	if [ -n "$port" ]; then
		procd_append_param command -port "$port"
	else
		procd_append_param command -listen "$listen"
	fi
	procd_append_param command -mode "$mode" -db "$db" -config "$cfg" -allow-origin "$origin"
	procd_set_param respawn 3600 5 5
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
}

reload_service() {
	sync_autostart
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "$SERVICE_CONF"
}
